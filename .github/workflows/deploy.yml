name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  AWS_REGION: us-east-1

jobs:
  # ===========================================================================
  # Job 1: Code Quality & Linting
  # ===========================================================================
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: |
          echo "## ðŸ” ESLint Results" >> $GITHUB_STEP_SUMMARY
          pnpm lint || {
            echo "âŒ ESLint found issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "âœ… No linting issues found" >> $GITHUB_STEP_SUMMARY

      - name: Check Prettier formatting
        run: |
          echo "## ðŸŽ¨ Prettier Check" >> $GITHUB_STEP_SUMMARY
          pnpm format:check || {
            echo "âŒ Code formatting issues found" >> $GITHUB_STEP_SUMMARY
            echo "Run 'pnpm format' locally to fix" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "âœ… Code is properly formatted" >> $GITHUB_STEP_SUMMARY

      - name: TypeScript type check
        run: |
          echo "## ðŸ“ TypeScript Check" >> $GITHUB_STEP_SUMMARY
          cd apps/api && pnpm typecheck
          cd ../web && pnpm typecheck
          cd ../../infra && pnpm typecheck
          echo "âœ… No type errors" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 2: API Tests
  # ===========================================================================
  test-api:
    name: Test API
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run API unit tests
        run: |
          cd apps/api
          pnpm test:coverage

      - name: Check coverage thresholds
        run: |
          cd apps/api
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âŒ Coverage ${COVERAGE}% is below 80% threshold"
            exit 1
          fi
          echo "âœ… Coverage ${COVERAGE}% meets 80% threshold"

      - name: Upload API coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/api/coverage/lcov.info
          flags: api
          name: api-coverage
          fail_ci_if_error: false

      - name: Generate coverage badge
        run: |
          cd apps/api
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "## ðŸ“Š API Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "Coverage: **${COVERAGE}%**" >> $GITHUB_STEP_SUMMARY
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            echo "Status: âœ… Passing (â‰¥80%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Status: âŒ Below threshold" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Job 3: Web Tests - SKIPPED (no tests in web folder)
  # ===========================================================================
  # All tests are located in apps/api folder

  # ===========================================================================
  # Job 4: Integration Tests
  # ===========================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run integration tests
        run: |
          cd apps/api
          pnpm test __tests__/integration
        env:
          AWS_REGION: us-east-1

      - name: Integration test summary
        run: |
          echo "## ðŸ§ª Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All integration tests passed" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 5: Build API
  # ===========================================================================
  build-api:
    name: Build API
    needs: [lint, test-api, test-integration]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API
        run: |
          cd apps/api
          pnpm build

      - name: Verify build output
        run: |
          if [ ! -f "apps/api/build/lambda.js" ]; then
            echo "âŒ Lambda handler not found"
            exit 1
          fi
          echo "âœ… API build successful"

      - name: Upload API build artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: apps/api/build
          retention-days: 7

  # ===========================================================================
  # Job 6: Build Web
  # ===========================================================================
  build-web:
    name: Build Web
    needs: [lint]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Web
        working-directory: apps/web
        env:
          NEXT_PUBLIC_API_URL: 'https://placeholder-api-url.com'
        run: |
          echo "Building Next.js app for validation..."
          echo "Note: This build uses a placeholder API URL for validation only."
          echo "The actual deployment will rebuild with the real API URL."
          pnpm build

      - name: Verify build output
        run: |
          if [ ! -d "apps/web/out" ]; then
            echo "âŒ out directory not found at apps/web/out"
            exit 1
          fi
          echo "âœ… Web build successful (validation only)"

  # ===========================================================================
  # Job 7: CDK Synthesize
  # ===========================================================================
  cdk-synth:
    name: CDK Synthesize
    needs: [build-api]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: |
          cd infra
          pnpm install --frozen-lockfile

      - name: Download API build
        uses: actions/download-artifact@v4
        with:
          name: api-build
          path: apps/api/build

      - name: Build CDK
        run: |
          cd infra
          pnpm build

      - name: Synthesize CloudFormation templates
        run: |
          cd infra
          pnpm synth
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Upload CDK templates
        uses: actions/upload-artifact@v4
        with:
          name: cdk-templates
          path: infra/cdk.out
          retention-days: 7

      - name: Generate deployment summary
        run: |
          echo "## ðŸ“¦ CDK Synthesis" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CloudFormation templates generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stacks:" >> $GITHUB_STEP_SUMMARY
          ls -1 infra/cdk.out/*.template.json | xargs -n1 basename >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 8: Deploy to Staging
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    needs: [cdk-synth, build-api]
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
      needs.build-api.result == 'success' &&
      needs.cdk-synth.result == 'success'
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.web_url }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: |
          cd infra
          pnpm install --frozen-lockfile

      - name: Download API build
        uses: actions/download-artifact@v4
        with:
          name: api-build
          path: apps/api/build

      - name: Build CDK
        run: |
          cd infra
          pnpm build

      - name: Deploy infrastructure stacks
        id: deploy
        run: |
          cd infra

          # Deploy MinimalStack first (contains API)
          pnpm cdk deploy MinimalStack --require-approval never

          # Get API URL from MinimalStack
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name MinimalStack \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text)

          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "API URL: $API_URL"

          # Deploy web stack (with API URL dependency)
          pnpm cdk deploy DocIntelProWebStack --require-approval never

          # Get web URL
          WEB_URL=$(aws cloudformation describe-stacks \
            --stack-name DocIntelProWebStack \
            --query 'Stacks[0].Outputs[?OutputKey==`WebsiteURL`].OutputValue' \
            --output text)

          echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT

      - name: Build Web with API URL
        working-directory: apps/web
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.deploy.outputs.api_url }}
        run: |
          echo "Building Next.js app with API URL: $NEXT_PUBLIC_API_URL"
          pnpm build

      - name: Deploy web content
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.deploy.outputs.api_url }}
        run: |
          cd infra
          node scripts/deploy-web-content.js

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "**Web URL:** ${{ steps.deploy.outputs.web_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ steps.deploy.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 9: Deploy to Production (Manual Approval)
  # ===========================================================================
  # Commented out for now - enable when ready for production deployments
  # deploy-production:
  #   name: Deploy to Production
  #   needs: deploy-staging
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
  #   environment:
  #     name: production
  #     url: ${{ steps.deploy.outputs.web_url }}
  #
  #   permissions:
  #     id-token: write
  #     contents: read
  #
  #   steps:
  #     - name: Manual Approval Required
  #       run: |
  #         echo "## â¸ï¸  Production Deployment Pending" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "**Status:** Waiting for manual approval" >> $GITHUB_STEP_SUMMARY
  #         echo "**Staging URL:** (completed)" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "â„¹ï¸  This deployment requires approval from authorized reviewers." >> $GITHUB_STEP_SUMMARY
  #         echo "Please review the staging deployment before approving." >> $GITHUB_STEP_SUMMARY
  #
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #
  #     - name: Setup pnpm
  #       uses: pnpm/action-setup@v3
  #       with:
  #         version: ${{ env.PNPM_VERSION }}
  #
  #     - name: Configure AWS credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         role-to-assume: ${{ secrets.AWS_ROLE_ARN_PRODUCTION }}
  #         aws-region: ${{ env.AWS_REGION }}
  #
  #     - name: Install dependencies
  #       run: |
  #         cd infra
  #         pnpm install --frozen-lockfile
  #
  #     - name: Download API build
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: api-build
  #         path: apps/api/build
  #
  #     - name: Build CDK
  #       run: |
  #         cd infra
  #         pnpm build
  #
  #     - name: Deploy infrastructure stacks
  #       id: deploy
  #       run: |
  #         cd infra
  #
  #         # Deploy MinimalStack first (contains API)
  #         pnpm cdk deploy MinimalStack --require-approval never
  #
  #         # Get API URL from MinimalStack
  #         API_URL=$(aws cloudformation describe-stacks \
  #           --stack-name MinimalStack \
  #           --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
  #           --output text)
  #
  #         echo "api_url=$API_URL" >> $GITHUB_OUTPUT
  #         echo "API URL: $API_URL"
  #
  #         # Deploy web stack (with API URL dependency)
  #         pnpm cdk deploy DocIntelProWebStack --require-approval never
  #
  #         # Get web URL
  #         WEB_URL=$(aws cloudformation describe-stacks \
  #           --stack-name DocIntelProWebStack \
  #           --query 'Stacks[0].Outputs[?OutputKey==`WebsiteURL`].OutputValue' \
  #           --output text)
  #
  #         echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT
  #
  #     - name: Build Web with API URL
  #       working-directory: apps/web
  #       env:
  #         NEXT_PUBLIC_API_URL: ${{ steps.deploy.outputs.api_url }}
  #       run: |
  #         echo "Building Next.js app with API URL: $NEXT_PUBLIC_API_URL"
  #         pnpm build
  #
  #     - name: Deploy web content
  #       env:
  #         NEXT_PUBLIC_API_URL: ${{ steps.deploy.outputs.api_url }}
  #       run: |
  #         cd infra
  #         node scripts/deploy-web-content.js
  #
  #     - name: Deployment summary
  #       run: |
  #         echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "**Status:** âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY
  #         echo "**Web URL:** ${{ steps.deploy.outputs.web_url }}" >> $GITHUB_STEP_SUMMARY
  #         echo "**API URL:** ${{ steps.deploy.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
  #         echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
  #         echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
  #
  #     - name: Send email notification
  #       if: success() && env.NOTIFICATION_EMAIL != ''
  #       env:
  #         NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
  #       run: |
  #         # This would typically use a service like SendGrid or AWS SES
  #         echo "Production deployment successful" | \
  #         mail -s "DocIntel Pro - Production Deployment" \
  #         $NOTIFICATION_EMAIL

  # ===========================================================================
  # Job 10: Failure Notifications
  # ===========================================================================
  notify-failure:
    name: Notify on Failure
    needs: [
        lint,
        test-api,
        test-integration,
        build-api,
        build-web,
        deploy-staging,
        # deploy-production, # Commented out
      ]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Create GitHub Issue on failure
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ CI/CD Pipeline Failed',
              body: `## Pipeline Failure Report
              
              **Workflow:** ${context.workflow}
              **Run ID:** ${context.runId}
              **Commit:** ${context.sha}
              **Author:** ${context.actor}
              **Branch:** ${context.ref}
              
              [View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              Please investigate and fix the failing jobs.`,
              labels: ['ci/cd', 'bug', 'automated']
            });
