name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  AWS_REGION: us-east-1

jobs:
  # ===========================================================================
  # Job 1: Code Quality & Linting
  # ===========================================================================
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: |
          echo "## üîç ESLint Results" >> $GITHUB_STEP_SUMMARY
          pnpm lint || {
            echo "‚ùå ESLint found issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "‚úÖ No linting issues found" >> $GITHUB_STEP_SUMMARY

      - name: Check Prettier formatting
        run: |
          echo "## üé® Prettier Check" >> $GITHUB_STEP_SUMMARY
          pnpm format:check || {
            echo "‚ùå Code formatting issues found" >> $GITHUB_STEP_SUMMARY
            echo "Run 'pnpm format' locally to fix" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "‚úÖ Code is properly formatted" >> $GITHUB_STEP_SUMMARY

      - name: TypeScript type check
        run: |
          echo "## üìù TypeScript Check" >> $GITHUB_STEP_SUMMARY
          cd apps/api && pnpm typecheck
          cd ../web && pnpm typecheck
          cd ../../infra && pnpm typecheck
          echo "‚úÖ No type errors" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 2: API Tests
  # ===========================================================================
  test-api:
    name: Test API
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run API unit tests
        run: |
          cd apps/api
          pnpm test:coverage

      - name: Check coverage thresholds
        run: |
          cd apps/api
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "‚ùå Coverage ${COVERAGE}% is below 80% threshold"
            exit 1
          fi
          echo "‚úÖ Coverage ${COVERAGE}% meets 80% threshold"

      - name: Upload API coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/api/coverage/lcov.info
          flags: api
          name: api-coverage
          fail_ci_if_error: false

      - name: Generate coverage badge
        run: |
          cd apps/api
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "## üìä API Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "Coverage: **${COVERAGE}%**" >> $GITHUB_STEP_SUMMARY
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            echo "Status: ‚úÖ Passing (‚â•80%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Status: ‚ùå Below threshold" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Job 3: Web Tests
  # ===========================================================================
  test-web:
    name: Test Web
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Web tests
        run: |
          cd apps/web
          pnpm test:coverage

      - name: Upload Web coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/web/coverage/lcov.info
          flags: web
          name: web-coverage
          fail_ci_if_error: false

  # ===========================================================================
  # Job 4: Integration Tests
  # ===========================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run integration tests
        run: |
          cd apps/api
          pnpm test:integration
        env:
          AWS_REGION: us-east-1

      - name: Integration test summary
        run: |
          echo "## üß™ Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ All integration tests passed" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 5: Build API
  # ===========================================================================
  build-api:
    name: Build API
    needs: [lint, test-api, test-integration]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API
        run: |
          cd apps/api
          pnpm build

      - name: Verify build output
        run: |
          if [ ! -f "apps/api/build/lambda.js" ]; then
            echo "‚ùå Lambda handler not found"
            exit 1
          fi
          echo "‚úÖ API build successful"

      - name: Upload API build artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: apps/api/build
          retention-days: 7

  # ===========================================================================
  # Job 6: Build Web
  # ===========================================================================
  build-web:
    name: Build Web
    needs: [lint, test-web]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Web
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
        run: |
          cd apps/web
          pnpm build

      - name: Upload Web build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: apps/web/.next
          retention-days: 7

  # ===========================================================================
  # Job 7: CDK Synthesize
  # ===========================================================================
  cdk-synth:
    name: CDK Synthesize
    needs: [build-api, build-web]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: |
          cd infra
          pnpm install --frozen-lockfile

      - name: Download API build
        uses: actions/download-artifact@v4
        with:
          name: api-build
          path: apps/api/build

      - name: Build CDK
        run: |
          cd infra
          pnpm build

      - name: Synthesize CloudFormation templates
        run: |
          cd infra
          pnpm synth
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Upload CDK templates
        uses: actions/upload-artifact@v4
        with:
          name: cdk-templates
          path: infra/cdk.out
          retention-days: 7

      - name: Generate deployment summary
        run: |
          echo "## üì¶ CDK Synthesis" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ CloudFormation templates generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stacks:" >> $GITHUB_STEP_SUMMARY
          ls -1 infra/cdk.out/*.template.json | xargs -n1 basename >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 8: Deploy to Staging
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    needs: cdk-synth
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.web_url }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: |
          cd infra
          pnpm install --frozen-lockfile

      - name: Download API build
        uses: actions/download-artifact@v4
        with:
          name: api-build
          path: apps/api/build

      - name: Download Web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: apps/web/.next

      - name: Build CDK
        run: |
          cd infra
          pnpm build

      - name: Deploy infrastructure stacks
        id: deploy
        run: |
          cd infra

          # Deploy MinimalStack first (contains API)
          pnpm cdk deploy MinimalStack --require-approval never

          # Get API URL from MinimalStack
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name MinimalStack \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text)

          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "API URL: $API_URL"

          # Deploy storage stack
          pnpm cdk deploy DocIntelProStorageStack --require-approval never

          # Deploy API stack
          pnpm cdk deploy DocIntelProApiStack --require-approval never

          # Deploy web stack (with API URL dependency)
          pnpm cdk deploy DocIntelProWebStack --require-approval never

          # Get web URL
          WEB_URL=$(aws cloudformation describe-stacks \
            --stack-name DocIntelProWebStack \
            --query 'Stacks[0].Outputs[?OutputKey==`WebsiteURL`].OutputValue' \
            --output text)

          echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT

      - name: Deploy web content
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.deploy.outputs.api_url }}
        run: |
          cd infra
          node scripts/deploy-web-content.js

      - name: Deployment summary
        run: |
          echo "## üöÄ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "**Web URL:** ${{ steps.deploy.outputs.web_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ steps.deploy.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack (Staging Success)
        if: success() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "‚úÖ Staging Deployment Successful",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Staging Deployment Successful"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nStaging"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Web URL:*\n${{ steps.deploy.outputs.web_url }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*API URL:*\n${{ steps.deploy.outputs.api_url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # ===========================================================================
  # Job 9: Deploy to Production (Manual Approval)
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.web_url }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PRODUCTION }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: |
          cd infra
          pnpm install --frozen-lockfile

      - name: Download API build
        uses: actions/download-artifact@v4
        with:
          name: api-build
          path: apps/api/build

      - name: Download Web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: apps/web/.next

      - name: Build CDK
        run: |
          cd infra
          pnpm build

      - name: Deploy infrastructure stacks
        id: deploy
        run: |
          cd infra

          # Deploy MinimalStack first (contains API)
          pnpm cdk deploy MinimalStack --require-approval never

          # Get API URL from MinimalStack
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name MinimalStack \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text)

          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "API URL: $API_URL"

          # Deploy storage stack
          pnpm cdk deploy DocIntelProStorageStack --require-approval never

          # Deploy API stack
          pnpm cdk deploy DocIntelProApiStack --require-approval never

          # Deploy web stack (with API URL dependency)
          pnpm cdk deploy DocIntelProWebStack --require-approval never

          # Get web URL
          WEB_URL=$(aws cloudformation describe-stacks \
            --stack-name DocIntelProWebStack \
            --query 'Stacks[0].Outputs[?OutputKey==`WebsiteURL`].OutputValue' \
            --output text)

          echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT

      - name: Deploy web content
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.deploy.outputs.api_url }}
        run: |
          cd infra
          node scripts/deploy-web-content.js

      - name: Deployment summary
        run: |
          echo "## üöÄ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "**Web URL:** ${{ steps.deploy.outputs.web_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ steps.deploy.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack (Production Success)
        if: success() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "üéâ Production Deployment Successful",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üéâ Production Deployment Successful"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Web URL:*\n${{ steps.deploy.outputs.web_url }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*API URL:*\n${{ steps.deploy.outputs.api_url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send email notification
        if: success() && secrets.NOTIFICATION_EMAIL != ''
        run: |
          # This would typically use a service like SendGrid or AWS SES
          echo "Production deployment successful" | \
          mail -s "DocIntel Pro - Production Deployment" \
          ${{ secrets.NOTIFICATION_EMAIL }}

  # ===========================================================================
  # Job 10: Failure Notifications
  # ===========================================================================
  notify-failure:
    name: Notify on Failure
    needs:
      [
        lint,
        test-api,
        test-web,
        test-integration,
        build-api,
        build-web,
        deploy-staging,
        deploy-production,
      ]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Notify Slack (Failure)
        if: secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "‚ùå CI/CD Pipeline Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå CI/CD Pipeline Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Create GitHub Issue on failure
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® CI/CD Pipeline Failed',
              body: `## Pipeline Failure Report
              
              **Workflow:** ${context.workflow}
              **Run ID:** ${context.runId}
              **Commit:** ${context.sha}
              **Author:** ${context.actor}
              **Branch:** ${context.ref}
              
              [View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              Please investigate and fix the failing jobs.`,
              labels: ['ci/cd', 'bug', 'automated']
            });
