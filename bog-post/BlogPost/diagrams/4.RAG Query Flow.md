sequenceDiagram autonumber participant Browser as ðŸ–¥ï¸ Browser participant APIGW as ðŸ”Œ API
Gateway participant Query as Î» query.handler participant Titan as ðŸ§  Bedrock Titan
participant OpenSearch as ðŸ” OpenSearch participant Claude as ðŸ¤– Bedrock Claude

    Browser->>APIGW: POST /query<br/>{question, workspaceId}
    APIGW->>Query: Invoke Lambda

    Note over Query: Step 1: Embed Question
    Query->>Titan: InvokeModel<br/>(amazon.titan-embed-text-v1)
    Titan-->>Query: Question vector [1536 dims]

    Note over Query: Step 2: Semantic Search
    Query->>OpenSearch: k-NN search<br/>(top 10, threshold > 0.5)
    OpenSearch-->>Query: Relevant chunks + scores

    Note over Query: Step 3: Build RAG Prompt
    Query->>Query: Construct prompt with:<br/>- System instructions<br/>- Retrieved context chunks<br/>- User question

    Note over Query: Step 4: Generate Answer
    Query->>Claude: InvokeModel<br/>(claude-3-haiku)
    Claude-->>Query: Generated answer

    Query-->>APIGW: {answer, sources, confidence}
    APIGW-->>Browser: 200 OK

    Note over Browser: Display answer<br/>with source citations
